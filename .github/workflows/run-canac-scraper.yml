name: Run CANAC Scraper (Local Runner) and Publish

on:
  workflow_dispatch:
    inputs:
      scraper_path:
        description: "Chemin COMPLET sur ton PC vers le dossier du scraper (où est run_all_canac_stores.py)"
        required: true
        default: "C:\\CANAC"
      econoplus_path:
        description: "Chemin COMPLET sur ton PC vers la racine du repo econoplus (dossier .git)"
        required: true
        default: "C:\\ECONOPLUS"
      scraper_entry:
        description: "Nom du fichier d’entrée du scraper"
        required: false
        default: "run_all_canac_stores.py"
      out_dir:
        description: "Nom du dossier de sortie généré par le scraper (dans scraper_path)"
        required: false
        default: "out_canac_json"
      publish_subdir:
        description: "Sous-dossier cible dans econoplus/public (ex: canac)"
        required: false
        default: "canac"
      commit_message:
        description: "Message de commit"
        required: false
        default: "Update CANAC liquidations"

jobs:
  run-and-publish:
    runs-on: self-hosted

    steps:
      - name: Checkout (for workflow repo only)
        uses: actions/checkout@v4

      - name: Validate paths + show files (debug)
        shell: powershell
        env:
          SCRAPER_PATH: ${{ inputs.scraper_path }}
          ECONOPLUS_PATH: ${{ inputs.econoplus_path }}
          SCRAPER_ENTRY: ${{ inputs.scraper_entry }}
          OUT_DIR: ${{ inputs.out_dir }}
          PUBLISH_SUBDIR: ${{ inputs.publish_subdir }}
        run: |
          $ErrorActionPreference = "Stop"

          Write-Host "SCRAPER_PATH     = $env:SCRAPER_PATH"
          Write-Host "ECONOPLUS_PATH   = $env:ECONOPLUS_PATH"
          Write-Host "SCRAPER_ENTRY    = $env:SCRAPER_ENTRY"
          Write-Host "OUT_DIR          = $env:OUT_DIR"
          Write-Host "PUBLISH_SUBDIR   = $env:PUBLISH_SUBDIR"

          if (-not (Test-Path $env:SCRAPER_PATH)) { throw "Scraper path not found: $env:SCRAPER_PATH" }
          if (-not (Test-Path $env:ECONOPLUS_PATH)) { throw "Econoplus path not found: $env:ECONOPLUS_PATH" }

          $entryFull = Join-Path $env:SCRAPER_PATH $env:SCRAPER_ENTRY
          if (-not (Test-Path $entryFull)) {
            throw "Entry script not found: $entryFull"
          }

          $gitFolder = Join-Path $env:ECONOPLUS_PATH ".git"
          if (-not (Test-Path $gitFolder)) {
            throw "ECONOPLUS_PATH must be the repo root (it must contain .git). Not found: $gitFolder"
          }

          Write-Host "OK. Entry script exists and econoplus looks like a git repo."

          Write-Host "===== Scraper folder contents (top-level) ====="
          Get-ChildItem -Path $env:SCRAPER_PATH -Force | Select-Object Name, Length

      - name: Run CANAC scraper (LOCAL on runner)
        shell: powershell
        env:
          SCRAPER_PATH: ${{ inputs.scraper_path }}
          SCRAPER_ENTRY: ${{ inputs.scraper_entry }}
        run: |
          $ErrorActionPreference = "Stop"
          Set-Location $env:SCRAPER_PATH

          # Use venv python if present, else system python
          $python = if (Test-Path ".\.venv\Scripts\python.exe") { ".\.venv\Scripts\python.exe" } else { "python" }

          Write-Host "Using python: $python"
          Write-Host "Running: $env:SCRAPER_ENTRY"

          & $python $env:SCRAPER_ENTRY

      - name: Copy output into econoplus/public/<publish_subdir>
        shell: powershell
        env:
          SCRAPER_PATH: ${{ inputs.scraper_path }}
          ECONOPLUS_PATH: ${{ inputs.econoplus_path }}
          OUT_DIR: ${{ inputs.out_dir }}
          PUBLISH_SUBDIR: ${{ inputs.publish_subdir }}
        run: |
          $ErrorActionPreference = "Stop"

          $outFull = Join-Path $env:SCRAPER_PATH $env:OUT_DIR
          if (-not (Test-Path $outFull)) {
            throw "Output folder not found: $outFull"
          }

          $target = Join-Path $env:ECONOPLUS_PATH ("public\" + $env:PUBLISH_SUBDIR)

          Write-Host "Output folder: $outFull"
          Write-Host "Target folder: $target"

          if (-not (Test-Path $target)) {
            Write-Host "Target does not exist, creating: $target"
            New-Item -ItemType Directory -Path $target | Out-Null
          }

          # Clean target to avoid stale files (optional but recommended)
          Write-Host "Cleaning target..."
          Get-ChildItem -Path $target -Force -ErrorAction SilentlyContinue | Remove-Item -Force -Recurse -ErrorAction SilentlyContinue

          Write-Host "Copying files..."
          Copy-Item -Path (Join-Path $outFull "*") -Destination $target -Recurse -Force

      - name: Git commit + push (econoplus)
        shell: powershell
        env:
          ECONOPLUS_PATH: ${{ inputs.econoplus_path }}
          COMMIT_MESSAGE: ${{ inputs.commit_message }}
        run: |
          $ErrorActionPreference = "Stop"
          Set-Location $env:ECONOPLUS_PATH

          git status
          git add .
          git commit -m "$env:COMMIT_MESSAGE" || echo "No changes to commit"
          git push
